{"ast":null,"code":"import _classCallCheck from \"C:\\\\projetos\\\\seed-dotnet6.0angular13\\\\Seed.Spa.Ui\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\classCallCheck.js\";\nimport _createClass from \"C:\\\\projetos\\\\seed-dotnet6.0angular13\\\\Seed.Spa.Ui\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\createClass.js\";\nimport { ElementRef, EventEmitter } from '@angular/core';\nimport { NgModel, FormControlName } from '@angular/forms';\nimport { ApiService } from '../services/api.service';\nimport { GlobalService } from \"../../global.service\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../services/api.service\";\nimport * as i2 from \"@angular/forms\";\nexport var DataSourceDirective = /*#__PURE__*/(function () {\n  var DataSourceDirective = /*#__PURE__*/function () {\n    function DataSourceDirective(_elemetRef, api, ngModel, controlName) {\n      _classCallCheck(this, DataSourceDirective);\n\n      this._elemetRef = _elemetRef;\n      this.api = api;\n      this.ngModel = ngModel;\n      this.controlName = controlName;\n      this.disabledOnInit = false;\n      this.enabledSelect2 = GlobalService.getGlobalSettings().enabledSelect2;\n      this.change = new EventEmitter();\n      this.fieldFilterName = \"nome\";\n      this.labelInitial = \"Selecione\";\n      this.filterBehavior = \"GetDataItem\";\n    }\n\n    _createClass(DataSourceDirective, [{\n      key: \"ngOnInit\",\n      value: function ngOnInit() {\n        var _this = this;\n\n        if (!this.disabledOnInit) this.datasource(this._elemetRef.nativeElement);\n        this._notificationEmitter = GlobalService.notification.subscribe(function (not) {\n          if (not.event == \"create\" || not.event == \"edit\" || not.event == \"init\") {\n            _this.init();\n          }\n\n          if (not.event == \"change\") {\n            if (not.data.dataitem == _this.dataitem) {\n              _this.datasource(_this._elemetRef.nativeElement, not.data.parentFilter);\n            }\n          }\n        });\n      }\n    }, {\n      key: \"init\",\n      value: function init() {\n        var _this2 = this;\n\n        $(this._elemetRef.nativeElement).val(null).trigger('change');\n        setTimeout(function () {\n          _this2.datasource(_this2._elemetRef.nativeElement);\n        }, 250);\n      }\n    }, {\n      key: \"control\",\n      get: function get() {\n        if (!this.controlName) {\n          return null;\n        }\n\n        return this.controlName.control;\n      }\n    }, {\n      key: \"hasFormControl\",\n      value: function hasFormControl() {\n        return this.controlName && this.controlName.control;\n      }\n    }, {\n      key: \"datasource\",\n      value: function datasource(el, parentFilter) {\n        el.options.length = 0;\n        var selectedValue = null;\n\n        if (this.ngModel.valueAccessor) {\n          this.accessor = this.ngModel.valueAccessor;\n\n          if (this.accessor.value) {\n            selectedValue = this.accessor.value;\n          }\n        }\n\n        if (!this.existsDefaultItem(el)) this.addOption(el, undefined, this.labelInitial);\n        if (this.enabledSelect2) this.select2(el, selectedValue, parentFilter);else this.select(el, selectedValue, parentFilter);\n      }\n    }, {\n      key: \"select\",\n      value: function select(el, selectedValue, parentFilter) {\n        var _this3 = this;\n\n        var filter = Object.assign(this.datafilters || {}, parentFilter || {});\n        this.api.setResource(this.dataitem, this.endpoint).getDataitem(filter).subscribe(function (data) {\n          for (var i = 0; i < data.dataList.length; i++) {\n            _this3.addOption(el, data.dataList[i].id, data.dataList[i].name);\n          }\n\n          if (selectedValue) el.value = _this3.accessor.value;\n        });\n      }\n    }, {\n      key: \"select2\",\n      value: function select2(el, selectedValue, parentFilter) {\n        var _this4 = this;\n\n        if (selectedValue) {\n          var filterOne = {};\n          filterOne[el.name] = selectedValue;\n          this.api.setResource(this.dataitem, this.endpoint).getDataitem(filterOne).subscribe(function (data) {\n            for (var i = 0; i < data.dataList.length; i++) {\n              _this4.addOption(el, data.dataList[i].id, data.dataList[i].name);\n            }\n\n            if (selectedValue) el.value = _this4.accessor.value;\n\n            _this4.select2Config(Object.assign(_this4.datafilters || {}, parentFilter || {}));\n          });\n        } else {\n          this.select2Config(Object.assign(this.datafilters || {}, parentFilter || {}));\n        }\n      }\n    }, {\n      key: \"select2Config\",\n      value: function select2Config(filters) {\n        var _this5 = this;\n\n        var element = $(this._elemetRef.nativeElement);\n        var ultimoValor = 0;\n        var config = {\n          ajax: this.api.setResource(this.dataitem, this.endpoint).getUrlConfig(true, this.fieldFilterName, this.filterBehavior, filters, null, this.labelInitial)\n        };\n        $(element).select2(config).on(\"select2:select\", function (e) {\n          var valor = $(e.currentTarget).val();\n\n          _this5.updateValue(valor, ultimoValor);\n\n          ultimoValor = valor;\n\n          _this5.change.emit({\n            target: {\n              value: valor\n            }\n          });\n        });\n      }\n    }, {\n      key: \"updateValue\",\n      value: function updateValue(value, valueold) {\n        if (this.ngModel) {\n          this.ngModel.viewToModelUpdate(value);\n\n          if (value != valueold) {\n            this.ngModel.control.markAsDirty();\n          }\n        }\n\n        if (this.hasFormControl()) {\n          this.control.setValue(value);\n\n          if (value != valueold) {\n            this.control.markAsDirty();\n          }\n        }\n      }\n    }, {\n      key: \"addOption\",\n      value: function addOption(el, value, text) {\n        if (this.existsItem(el, value)) return;\n        var option = document.createElement(\"option\");\n        option.text = text;\n        option.value = value;\n        el.add(option);\n      }\n    }, {\n      key: \"existsItem\",\n      value: function existsItem(el, value) {\n        var found = false;\n\n        if (el.options) {\n          for (var i = 0; i < el.options.length; i++) {\n            if (el.options[i].value == value) found = true;\n          }\n        }\n\n        return found;\n      }\n    }, {\n      key: \"existsDefaultItem\",\n      value: function existsDefaultItem(el) {\n        var found = false;\n\n        if (el.options) {\n          for (var i = 0; i < el.options.length; i++) {\n            if (el.options[i].text == this.labelInitial) found = true;\n          }\n        }\n\n        return found;\n      }\n    }, {\n      key: \"ngOnDestroy\",\n      value: function ngOnDestroy() {\n        $(this._elemetRef.nativeElement).select2();\n        $(this._elemetRef.nativeElement).select2('destroy');\n        if (this._notificationEmitter) this._notificationEmitter.unsubscribe();\n      }\n    }]);\n\n    return DataSourceDirective;\n  }();\n\n  DataSourceDirective.ɵfac = function DataSourceDirective_Factory(t) {\n    return new (t || DataSourceDirective)(i0.ɵɵdirectiveInject(i0.ElementRef), i0.ɵɵdirectiveInject(i1.ApiService), i0.ɵɵdirectiveInject(i2.NgModel), i0.ɵɵdirectiveInject(i2.FormControlName, 10));\n  };\n\n  DataSourceDirective.ɵdir = /*@__PURE__*/i0.ɵɵdefineDirective({\n    type: DataSourceDirective,\n    selectors: [[\"\", \"datasource\", \"\"]],\n    inputs: {\n      dataitem: \"dataitem\",\n      endpoint: \"endpoint\",\n      datafilters: \"datafilters\",\n      fieldFilterName: \"fieldFilterName\",\n      disabledOnInit: \"disabledOnInit\",\n      enabledSelect2: \"enabledSelect2\",\n      labelInitial: \"labelInitial\",\n      filterBehavior: \"filterBehavior\"\n    },\n    outputs: {\n      change: \"change\"\n    },\n    features: [i0.ɵɵProvidersFeature([NgModel])]\n  });\n  return DataSourceDirective;\n})();","map":null,"metadata":{},"sourceType":"module"}